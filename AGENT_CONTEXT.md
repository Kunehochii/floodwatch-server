# AGENT_CONTEXT: FloodWatch Backend

> **Purpose:** Agent-optimized reference for understanding and modifying the FloodWatch backend codebase.

---

## Directory Structure

```
floodwatch-server/
├── main.py              # FastAPI server with video streaming & detection
├── calibrate.py         # HSV calibration tool for color marker setup
├── calibration.json     # HSV color ranges (generated by calibrate.py)
├── requirements.txt     # Python dependencies
├── AGENT_CONTEXT.md     # This file
└── FLOODWATCH_BACKEND_SPEC.md  # API specification for frontend integration
```

---

## Core Files

### main.py
**Purpose:** FastAPI backend server for real-time flood detection.

**Key Components:**
| Component | Location | Description |
|-----------|----------|-------------|
| `load_calibration()` | Function | Loads HSV ranges from `calibration.json` |
| `detect_water_level(frame)` | Function | Core detection algorithm, returns `(level, message, presence)` |
| `generate_frames()` | Generator | MJPEG frame generator for video streaming |
| `current_status` | Global dict | Stores latest detection state |
| `calibration_config` | Global dict | Stores loaded HSV ranges |

**API Endpoints:**
| Method | Path | Returns |
|--------|------|---------|
| GET | `/` | Health check JSON |
| GET | `/video_feed` | MJPEG stream (multipart) |
| GET | `/status` | Detection status JSON |
| GET | `/calibration` | Current HSV config JSON |
| POST | `/calibration/reload` | Reload config from file |

**Detection Logic (Disappearance Algorithm):**
1. Convert frame to HSV
2. Create masks for yellow, orange, red using calibration ranges
3. Count non-zero pixels per mask
4. If count < `PIXEL_THRESHOLD` (300): color is "missing"
5. Determine level based on which colors are missing:
   - Level 0: All visible (NORMAL)
   - Level 1: Yellow missing (WARNING)
   - Level 2: Yellow+Orange missing (CRITICAL)
   - Level 3: All missing (FLOOD)

---

### calibrate.py
**Purpose:** PC-based HSV color calibration tool.

**Key Components:**
| Component | Type | Description |
|-----------|------|-------------|
| `HSVCalibrator` | Class | Main calibration interface |
| `run_with_camera()` | Method | Live camera calibration mode |
| `run_with_image()` | Method | Static image calibration mode |
| `save_to_file()` | Method | Exports to `calibration.json` |

**Controls:**
- `Y/O/R` keys: Select color to calibrate
- `S` key: Save current slider values
- `Q` key: Quit and save to file
- `ESC` key: Quit without saving
- 6 trackbars: Low/High H, S, V adjustment

**CLI Arguments:**
```
--camera, -c  : Camera index (default: 0)
--image, -i   : Path to static image
--output, -o  : Output file path (default: calibration.json)
```

---

### calibration.json
**Purpose:** Stores HSV color boundaries for marker detection.

**Schema:**
```json
{
  "<color>": {
    "lower": [H, S, V],  // 0-179, 0-255, 0-255
    "upper": [H, S, V]
  }
}
```

**Required Keys:** `yellow`, `orange`, `red`

---

## Common Modification Scenarios

### Adding a new color marker
1. In `calibration.json`: Add new color entry with `lower`/`upper` arrays
2. In `main.py` > `detect_water_level()`: Update level determination logic
3. In `calibrate.py`: Add new key binding in `run_with_camera()` and `run_with_image()`

### Adjusting detection sensitivity
- Modify `PIXEL_THRESHOLD` constant in `main.py` (default: 300)
- Lower = more sensitive, Higher = less sensitive

### Adding new API endpoints
- Add route decorator in `main.py` using `@app.get()` or `@app.post()`
- Include appropriate `tags=["..."]` for OpenAPI grouping
- Return data using `JSONResponse` or `StreamingResponse`

### Changing video source
- Modify `cv2.VideoCapture(0)` in `generate_frames()` 
- `0` = default camera, `1` = secondary camera
- Can also pass RTSP URL for IP cameras

---

## Dependencies

| Package | Purpose |
|---------|---------|
| fastapi | Web framework with async support |
| uvicorn | ASGI server |
| opencv-python | Computer vision / video capture |
| numpy | Array operations for HSV masks |

---

## Running the Server

```bash
# Install dependencies
pip install -r requirements.txt

# Run calibration (on PC with camera)
python calibrate.py

# Start server (on Raspberry Pi)
python main.py
# Or with auto-reload:
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

---

## Integration Notes

- Frontend connects via `VITE_API_URL` environment variable
- CORS is enabled for all origins (restrict in production)
- Video feed is MJPEG, consumed via `<img src="...">` tag
- Status polling recommended at 1-second intervals
